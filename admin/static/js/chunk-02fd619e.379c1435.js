(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-02fd619e"],{"17c7":function(e,t,a){},9406:function(e,t,a){"use strict";a.r(t);var o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"dashboard-container"},[[a("h4",{staticClass:"title"},[e._v("订单管理中心")]),e._v(" "),a("el-form",{staticClass:"demo-form-inline",attrs:{inline:!0,model:e.query,size:"small"}},[a("el-form-item",[a("el-input",{staticClass:"input-with-select",attrs:{placeholder:"请输入查询的内容",clearable:""},model:{value:e.query[e.select],callback:function(t){e.$set(e.query,e.select,t)},expression:"query[select]"}},[a("el-select",{staticStyle:{width:"120px","text-align":"center"},attrs:{slot:"prepend",placeholder:"请选择"},on:{change:e.changeQuery},slot:"prepend",model:{value:e.select,callback:function(t){e.select=t},expression:"select"}},[a("el-option",{attrs:{label:"订单号",value:"order_id"}}),e._v(" "),a("el-option",{attrs:{label:"外部订单号",value:"out_order_no"}}),e._v(" "),a("el-option",{attrs:{label:"卡号",value:"card_number"}}),e._v(" "),a("el-option",{attrs:{label:"姓名",value:"name"}}),e._v(" "),a("el-option",{attrs:{label:"金额",value:"money"}})],1)],1)],1),e._v(" "),a("el-form-item",{directives:[{name:"permission",rawName:"v-permission",value:["admins"],expression:"['admins']"}],attrs:{label:"管理员"}},[a("el-select",{attrs:{placeholder:"请选择管理员",clearable:""},model:{value:e.query.adminid,callback:function(t){e.$set(e.query,"adminid",t)},expression:"query.adminid"}},[a("el-option",{attrs:{label:"全部",value:""}}),e._v(" "),e._l(e.admins,function(e,t){return a("el-option",{key:e.id,attrs:{label:e.nickname,value:e.id}})})],2)],1),e._v(" "),a("el-form-item",{attrs:{label:"订单状态"}},[a("el-select",{attrs:{placeholder:"请选择订单状态",clearable:""},model:{value:e.query.status,callback:function(t){e.$set(e.query,"status",t)},expression:"query.status"}},[a("el-option",{attrs:{label:"全部",value:""}}),e._v(" "),a("el-option",{attrs:{label:"未确认",value:"-1"}}),e._v(" "),a("el-option",{attrs:{label:"未处理",value:0}}),e._v(" "),a("el-option",{attrs:{label:"进行中",value:1}}),e._v(" "),a("el-option",{attrs:{label:"成功",value:2}}),e._v(" "),a("el-option",{attrs:{label:"失败",value:3}})],1)],1),e._v(" "),a("el-form-item",{attrs:{label:"时间"}},[a("el-date-picker",{attrs:{type:"datetimerange","picker-options":e.pickerOptions,"value-format":"yyyy-MM-dd HH:mm:ss","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",align:"right"},model:{value:e.query.range,callback:function(t){e.$set(e.query,"range",t)},expression:"query.range"}})],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{type:"primary"},on:{click:e.onSearch}},[e._v("查询")])],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{icon:"el-icon-plus"},on:{click:e.onDialogSite}},[e._v("添加")])],1),e._v(" "),a("el-form-item",[a("el-upload",{staticClass:"upload-csv",attrs:{disabled:e.uploadLoading,"show-file-list":!1,headers:e.token,"on-progress":e.uploadProgress,"on-success":e.uploadSuccess,"on-error":e.uploadError,action:e.baseApiUrl+"/api.php?a=uploadCsv"}},[a("el-button",{attrs:{size:"small",icon:"el-icon-upload2",loading:e.uploadLoading}},[e._v("上传")])],1)],1)],1),e._v(" "),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.tableLoading,expression:"tableLoading"}],staticStyle:{width:"100%"},attrs:{data:e.tableData.list,border:"","show-summary":"","summary-method":e.getSummaries,size:"small"}},[a("el-table-column",{attrs:{width:"80px",prop:"id",label:"id"}}),e._v(" "),e.checkPermission(["admins"])?a("el-table-column",{attrs:{width:"100px",prop:"username",label:"管理员账号"}}):e._e(),e._v(" "),a("el-table-column",{attrs:{prop:"out_order_no",label:"外部订单号"}}),e._v(" "),a("el-table-column",{attrs:{width:"100px",prop:"money",label:"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",{staticStyle:{color:"#ff6c6c"}},[e._v(e._s(t.row.money))])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"card_number",label:"卡号"}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"姓名"}}),e._v(" "),a("el-table-column",{attrs:{width:"80px",label:"状态"},scopedSlots:e._u([{key:"default",fn:function(t){return[2==t.row.status?a("el-tag",{attrs:{type:"success",size:"small"}},[e._v("成功")]):3==t.row.status?a("el-tag",{attrs:{type:"danger",size:"small"}},[e._v("失败")]):1==t.row.status?a("el-tag",{attrs:{size:"small"}},[e._v("进行中")]):-1==t.row.status?a("el-tag",{attrs:{type:"warning",size:"small"}},[e._v("未确认")]):a("el-tag",{attrs:{type:"info",size:"small"}},[e._v("未处理")])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"created_at",label:"创建时间"}}),e._v(" "),a("el-table-column",{attrs:{label:"操作",width:"280px"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{size:"mini"},on:{click:function(a){return e.onDialogView(t.row)}}},[e._v("查看详情\n          ")]),e._v(" "),-1==t.row.status?a("el-button-group",[a("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(a){return e.onConfirmOrderNo(t.$index,t.row)}}},[e._v("确认订单\n            ")]),e._v(" "),a("el-button",{attrs:{size:"mini"},on:{click:function(a){return e.onCancelOrder(t.row.id)}}},[e._v("取消订单\n            ")])],1):e._e()]}}])})],1),e._v(" "),a("div",{staticClass:"block",staticStyle:{"margin-top":"20px","text-align":"right"}},[a("el-pagination",{attrs:{"current-page":e.query.page,"page-size":e.query.count,layout:"sizes ,prev, pager, next",total:e.tableData.total},on:{"size-change":e.handleSizeChange,"update:currentPage":function(t){return e.$set(e.query,"page",t)},"update:current-page":function(t){return e.$set(e.query,"page",t)},"current-change":e.handleCurrentChange}})],1),e._v(" "),a("el-dialog",{attrs:{title:e.dialog.title,visible:e.dialog.visible,width:e.dialog.width},on:{"update:visible":function(t){return e.$set(e.dialog,"visible",t)}}},["viewOrder"===e.dialog.action?a("div",{staticClass:"view-table-div",staticStyle:{"margin-top":"-15px"}},[a("table",{attrs:{border:"0px",cellpadding:"0",cellspacing:"0"}},[a("thead",[a("tr",[a("td",{attrs:{colspan:"2"}},[e._v("订单信息")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("订单号")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.order_id))])]),e._v(" "),a("tr",[a("td",[e._v("外部订单号")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.out_order_no))])]),e._v(" "),a("tr",[a("td",[e._v("银行名称")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.bank_name))])]),e._v(" "),a("tr",[a("td",[e._v("转账金额")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.money))])]),e._v(" "),a("tr",[a("td",[e._v("银行卡号")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.card_number))])]),e._v(" "),a("tr",[a("td",[e._v("姓名")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.name))])]),e._v(" "),a("tr",[a("td",[e._v("确认工号")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.worker||"-"))])]),e._v(" "),a("tr",[a("td",[e._v("创建时间")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.created_at))])]),e._v(" "),a("tr",[a("td",[e._v("最后更新时间")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.updated_at))])])])]),e._v(" "),a("table",{attrs:{border:"0px",cellpadding:"0",cellspacing:"0"}},[a("thead",[a("tr",[a("td",{attrs:{colspan:"2"}},[e._v("处理结果")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("操作状态")]),e._v(" "),a("td",[2==e.dialog.table.status?a("span",{staticStyle:{color:"#67c23a"}},[e._v("成功")]):3==e.dialog.table.status?a("span",{staticStyle:{color:"#f56c6c"}},[e._v("失败")]):-1==e.dialog.table.status?a("span",[e._v("待确认")]):1==e.dialog.table.status?a("span",{staticStyle:{color:"#409EFF"}},[e._v("进行中")]):a("span",{staticStyle:{color:"#909399"}},[e._v("未处理")])])]),e._v(" "),a("tr",[a("td",[e._v("操作卡号")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.task_card_no||"-"))])]),e._v(" "),a("tr",[a("td",[e._v("账面余额")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.task_balance||"-"))])]),e._v(" "),a("tr",[a("td",[e._v("失败原因")]),e._v(" "),a("td",[e._v(e._s(e.dialog.table.msg||"-"))])])])])]):e._e(),e._v(" "),"addOrder"===e.dialog.action?a("el-form",{ref:"dialogForm",attrs:{model:e.dialog.form,rules:e.dialog.rules,"label-width":"110px"}},[a("el-form-item",{attrs:{label:"外部订单号",prop:"out_order_no"}},[a("el-input",{attrs:{placeholder:"请输入外部订单号"},model:{value:e.dialog.form.out_order_no,callback:function(t){e.$set(e.dialog.form,"out_order_no",t)},expression:"dialog.form.out_order_no"}})],1),e._v(" "),a("input",{directives:[{name:"model",rawName:"v-model",value:e.dialog.form.bank_name,expression:"dialog.form.bank_name"}],attrs:{type:"hidden"},domProps:{value:e.dialog.form.bank_name},on:{input:function(t){t.target.composing||e.$set(e.dialog.form,"bank_name",t.target.value)}}}),e._v(" "),a("el-form-item",{attrs:{label:"银行卡号",prop:"card_number"}},[a("el-input",{attrs:{placeholder:"请输入银行卡号"},model:{value:e.dialog.form.card_number,callback:function(t){e.$set(e.dialog.form,"card_number",t)},expression:"dialog.form.card_number"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"开户姓名",prop:"name"}},[a("el-input",{attrs:{placeholder:"请输入开户姓名"},model:{value:e.dialog.form.name,callback:function(t){e.$set(e.dialog.form,"name",t)},expression:"dialog.form.name"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"转账金额",prop:"money"}},[a("el-tooltip",{attrs:{manual:!0,placement:"top"},model:{value:e.moneySplitTip,callback:function(t){e.moneySplitTip=t},expression:"moneySplitTip"}},[a("div",{staticStyle:{width:"430px"},attrs:{slot:"content"},slot:"content"},[a("div",{staticStyle:{"font-size":"16px"}},[e._v("拆分提示")]),e._v(" "),a("div",{staticStyle:{color:"#e6a23c","font-size":"14px"}},[e._v("当前金额>=5000，订单自动拆分金额为："+e._s(e.moneySplitArr&&e.moneySplitArr)+"\n              ")])]),e._v(" "),a("el-input",{attrs:{placeholder:"请输入订单金额"},model:{value:e.dialog.form.money,callback:function(t){e.$set(e.dialog.form,"money",t)},expression:"dialog.form.money"}},[a("template",{slot:"append"},[e._v("元")])],2)],1)],1),e._v(" "),a("el-form-item",[a("el-button",{on:{click:function(t){e.dialog.visible=!1}}},[e._v("取 消")]),e._v(" "),a("el-button",{attrs:{type:"primary",loading:e.dialog.btnLoading,disabled:e.dialog.btnDisabled},on:{click:function(t){return e.dialogFormSubmit()}}},[e._v("确 定\n          ")])],1)],1):e._e()],1)]],2)},r=[],i=(a("456d"),a("7f7f"),a("c5f6"),a("ac6a"),a("b775"));function l(e){return Object(i["a"])({url:"api.php?a=orders",method:"get",params:e})}function n(e){return Object(i["a"])({url:"api.php?a=create",method:"post",data:e})}function s(e){return Object(i["a"])({url:"api.php?a=admins",method:"get",params:e})}function d(e){return Object(i["a"])({url:"api.php?a=cancel",method:"get",params:e})}function c(e){return Object(i["a"])({url:"api.php?a=confirmOrderNo",method:"get",params:e})}var u=a("bc3a"),m=a.n(u),p=a("4381"),g=a("e350"),v={name:"Dashboard",directives:{permission:p["a"]},data:function(){var e=this,t=function(t,a,o){e.dialog.form.out_order_no===a&&void 0!==e.dialog.form.out_order_no&&void 0!==a?o(new Error("外部订单号与银行卡号不能一致")):o()},a=function(t,a,o){parseFloat(a)>5e4?o(new Error("转账金额不能大于50000")):(e.moneySplitArr=e.orderSplits(a),e.moneySplitTip=!!e.moneySplitArr,o())};return{set:null,baseApiUrl:"./",currentRole:"adminDashboard",admin:"",query:{count:10,page:1},select:"order_id",tableData:{list:[],count:0,total:0},admins:[],tableLoading:!1,moneySplitTip:!1,moneySplitArr:[],dialog:{title:"",width:"600px",visible:!1,form:{},btnLoading:!1,btnDisabled:!1,action:null,table:{},rules:{out_order_no:{required:!0,message:"外部订单号不能为空",trigger:"blur"},card_number:[{required:!0,message:"银行卡号不能为空",trigger:"blur"},{pattern:/[\d]/,message:"不能包含字符串或其他特殊字符",trigger:"change"},{min:16,max:19,message:"银行卡号最小长度16位，最大长度19位",trigger:"blur"},{validator:t,trigger:"change"}],name:[{required:!0,message:"开户姓名不能为空",trigger:"blur"},{min:2,max:8,message:"开户姓名最小长度2位，最大8位",trigger:"blur"}],money:[{required:!0,message:"转账金额不能为空",trigger:"blur"},{pattern:/[\d]/,message:"转账金额必须是数字",trigger:"change"},{validator:a,trigger:"change"}]}},uploadLoading:!1,confirmLoading:!1,token:{token:this.$store.state.user.token},pickerOptions:{shortcuts:[{text:"最近一周",onClick:function(e){var t=new Date,a=new Date;a.setTime(a.getTime()-6048e5),e.$emit("pick",[a,t])}},{text:"最近一个月",onClick:function(e){var t=new Date,a=new Date;a.setTime(a.getTime()-2592e6),e.$emit("pick",[a,t])}},{text:"最近三个月",onClick:function(e){var t=new Date,a=new Date;a.setTime(a.getTime()-7776e6),e.$emit("pick",[a,t])}}]}}},computed:{},watch:{"dialog.visible":function(e,t){this.dialog.btnDisabled=!e}},created:function(){this.poll(),this.checkPermission(["admins"])&&this.init()},methods:{checkPermission:g["a"],changeQuery:function(){this.query={count:10,page:1}},orderSplits:function(e){if(e>=5e3){for(var t=0,a=4999,o=0;o<20;o++){var r=e/o;if(r<=a){t=o;break}}for(var i=parseInt(e/t),l=e-i*t,n=[],s=0;s<t;s++){var d=i+l;d>=a?(n[s]=a,l=d-a):(n[s]=d,l=0)}return n}return!1},poll:function(){var e=this;this.set=setTimeout(function(){e.netTableData(!1,e.poll)},1e3)},init:function(){this.netAdmins()},netAdmins:function(){var e=this;s().then(function(t){var a=t.data;e.admins=a}).catch(function(t){e.$message.error(t)})},getSummaries:function(e){var t=e.columns,a=e.data,o=[];return t.forEach(function(e,t){if(0!==t){var r=a.map(function(t){return Number(t[e.property])});"金额"===e.label?(o[t]=r.reduce(function(e,t){var a=Number(t);return isNaN(a)?e:e+t},0),o[t]=o[t].toFixed(2)):o[t]="N/A"}else o[t]="总计"}),o},onSearch:function(){this.query.page=1,this.netTableData(!0)},dialogFormSubmit:function(){var e=this;this.$refs.dialogForm.validate(function(t){if(t){e.dialog.btnLoading=!0;var a=e.dialog.form.money,o=(e.orderSplits(e.dialog.form.money)||[a]).map(function(t){return e.createOrder(Object.assign(JSON.parse(JSON.stringify(e.dialog.form)),{money:t}))}),r=o.length>1;m.a.all(o).then(m.a.spread(function(t){var a=t.data;r||-1===parseInt(a.data.status)&&e.$confirm("今天已经给 "+e.dialog.form.name+" 转过 "+e.dialog.form.money+"元，请确认是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"warning"}),e.moneySplitTip=!1,e.dialog.btnLoading=!1,e.netTableData(),e.closeDialog()})).catch(function(t){e.moneySplitTip=!1,e.dialog.btnLoading=!1,e.$message.error(t)})}})},createOrder:function(e){var t=this;return n(Object.assign(e,{scatter:e.money!==this.dialog.form.money})).then(function(e){console.log(e),e.success?(t.dialog.visible=!1,t.$message.success("创建成功")):t.$message.error(e.errMsg)}).catch(function(e){t.$message.error(e)})},onCancelOrder:function(e){var t=this;return d({id:e}).then(function(e){e.data;t.netTableData(!0),t.closeDialog()}).catch(function(e){t.dialog.btnLoading=!1,t.$message.error(e)})},closeDialog:function(){this.dialog.visible=!1},onDialogSite:function(){this.dialog.title="创建订单",this.dialog.width="600px",this.dialog.visible=!0,this.dialog.action="addOrder",this.dialog.form={bank_name:"自动识别"},this.$refs.dialogForm&&this.$refs.dialogForm.clearValidate()},onDialogView:function(e){this.dialog.title="查看订单",this.dialog.width="600px",this.dialog.visible=!0,this.dialog.action="viewOrder",this.dialog.table=e},netTableData:function(e,t){var a=this;this.tableLoading=e;var o=[];Object.keys(this.query).forEach(function(e){var t=a.query[e];null!==t&&"undefined"!==typeof t&&""!==t&&o.push(e+"="+t)}),o.length&&o.unshift("&"),l(this.query).then(function(e){var o=e.data;a.tableLoading=!1,a.tableData=o,t&&t()}).catch(function(e){a.$message.error(e),a.tableLoading=!1,t&&t()})},handleCurrentChange:function(){this.netTableData(!0)},handleSizeChange:function(e){this.query.page=1,this.query.count=e,this.netTableData(!0)},uploadProgress:function(e,t,a){this.uploadLoading=!0},uploadSuccess:function(e,t,a){this.uploadLoading=!1,e.success?e.data.length>0&&(this.query.page=1,this.netTableData(!0)):this.$message.error(e.errMsg)},uploadError:function(e,t,a){this.uploadLoading=!1},onConfirmOrderNo:function(e,t){var a=this,o=/^(\w{3,8})$/;this.$prompt("请输入您的操作工号","提示",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:o,inputErrorMessage:"工号格式不正确"}).then(function(e){var o=e.value;c({id:t.id,worker:o}).then(function(e){e.data;a.netTableData(!0),a.closeDialog()}).catch(function(e){a.dialog.btnLoading=!1,a.$message.error(e)})})}},destroyed:function(){clearTimeout(this.set)}},_=v,b=(a("af54"),a("2877")),f=Object(b["a"])(_,o,r,!1,null,null,null);t["default"]=f.exports},af54:function(e,t,a){"use strict";var o=a("17c7"),r=a.n(o);r.a}}]);